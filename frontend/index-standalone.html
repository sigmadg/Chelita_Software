<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Ana Gabriela Ordoñez Güemes" />
    <title>Chelita Software - Fullstack Test</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * { box-sizing: border-box; }
      body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; min-height: 100vh; background: #f0f2f5; color: #1a1a2e; }
      #root { max-width: 560px; margin: 0 auto; padding: 2rem 1rem; }
      h1 { font-size: 1.5rem; color: #16213e; margin: 0 0 1.5rem; text-align: center; }
      .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
      .card h2 { font-size: 1rem; color: #16213e; margin: 0 0 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e8eaed; }
      .form-group { margin-bottom: 1rem; }
      label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.35rem; }
      input { width: 100%; padding: 0.6rem 0.75rem; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 8px; }
      input:focus { outline: none; border-color: #3b82f6; }
      button { width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 500; color: #fff; background: #2563eb; border: none; border-radius: 8px; cursor: pointer; margin-top: 0.5rem; }
      button:hover { background: #1d4ed8; }
      button:disabled { background: #9ca3af; cursor: not-allowed; }
      .message { padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.9rem; margin-top: 1rem; }
      .message.success { background: #d1fae5; color: #065f46; }
      .message.error { background: #fee2e2; color: #991b1b; }
      .code-display { font-family: monospace; font-size: 1.25rem; letter-spacing: 0.1em; padding: 0.75rem; background: #f3f4f6; border-radius: 8px; text-align: center; margin-top: 0.5rem; }
      .download-section { display: flex; gap: 0.5rem; margin-top: 1rem; }
      .download-section input { flex: 1; }
      .download-section button { flex: 0 0 auto; width: auto; min-width: 120px; }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
      const { useState } = React;
      const API_BASE = 'http://localhost:8000';

      function downloadPdfFromBase64(base64, filename) {
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64;
        link.download = filename || 'documento.pdf';
        link.click();
      }

      function App() {
        const [form, setForm] = useState({ nombre: '', apellido: '', edad: '', telefono: '', correo: '' });
        const [documentCode, setDocumentCode] = useState('');
        const [downloadCode, setDownloadCode] = useState('');
        const [message, setMessage] = useState({ type: '', text: '' });
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setMessage({ type: '', text: '' });
          setLoading(true);
          try {
            const res = await fetch(API_BASE + '/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(form),
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Error al crear documento');
            setDocumentCode(result.document_code);
            setMessage({ type: 'success', text: 'Documento creado. Guarda el código para descargarlo después.' });
          } catch (err) {
            setMessage({ type: 'error', text: err.message });
          } finally {
            setLoading(false);
          }
        };

        const handleDownloadByCode = async (e) => {
          e.preventDefault();
          const code = downloadCode.trim();
          if (!code || code.length !== 10) {
            setMessage({ type: 'error', text: 'El código debe tener exactamente 10 caracteres.' });
            return;
          }
          setMessage({ type: '', text: '' });
          setLoading(true);
          try {
            const res = await fetch(API_BASE + '/document/' + encodeURIComponent(code));
            const result = await res.json();
            if (!res.ok) throw new Error(result.detail || 'Error al obtener documento');
            downloadPdfFromBase64(result.document_b64, 'documento-' + code + '.pdf');
            setMessage({ type: 'success', text: 'PDF descargado correctamente.' });
          } catch (err) {
            setMessage({ type: 'error', text: err.message });
          } finally {
            setLoading(false);
          }
        };

        return (
          <>
            <h1>Chelita Software - Fullstack Test</h1>
            <div className="card">
              <h2>Crear documento PDF</h2>
              <form onSubmit={handleSubmit}>
                {['nombre','apellido','edad','telefono','correo'].map(key => (
                  <div key={key} className="form-group">
                    <label>{key === 'correo' ? 'Correo' : key.charAt(0).toUpperCase() + key.slice(1)}</label>
                    <input type={key === 'correo' ? 'email' : 'text'} value={form[key]} onChange={e => setForm(f => ({ ...f, [key]: e.target.value }))} required />
                  </div>
                ))}
                <button type="submit" disabled={loading}>{loading ? 'Creando...' : 'Crear PDF y obtener código'}</button>
              </form>
              {documentCode && <><p style={{ marginTop: '1rem', marginBottom: 0 }}><strong>Código del documento:</strong></p><div className="code-display">{documentCode}</div></>}
              {message.text && <div className={'message ' + message.type}>{message.text}</div>}
            </div>
            <div className="card">
              <h2>Descargar PDF por código</h2>
              <p style={{ margin: '0 0 1rem', fontSize: '0.9rem', color: '#6b7280' }}>Ingresa el código de 10 caracteres para descargar el PDF.</p>
              <form onSubmit={handleDownloadByCode}>
                <div className="download-section">
                  <input type="text" placeholder="Ej: EJ21243DIK" value={downloadCode} onChange={e => setDownloadCode(e.target.value.toUpperCase())} maxLength={10} />
                  <button type="submit" disabled={loading}>{loading ? '...' : 'Descargar PDF'}</button>
                </div>
              </form>
            </div>
          </>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
